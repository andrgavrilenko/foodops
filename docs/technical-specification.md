# FoodOps -- Техническое задание

**Версия документа:** 1.0
**Дата:** 2026-02-09
**Статус:** Черновик
**Автор:** Команда FoodOps

---

## Содержание

1. [Общее описание проекта и цели](#1-общее-описание-проекта-и-цели)
2. [Пользовательские сценарии (User Stories)](#2-пользовательские-сценарии-user-stories)
3. [Функциональные требования](#3-функциональные-требования)
4. [Нефункциональные требования](#4-нефункциональные-требования)
5. [Архитектурные компоненты системы](#5-архитектурные-компоненты-системы)
6. [Модель данных](#6-модель-данных)
7. [API контракты](#7-api-контракты)
8. [Интеграции](#8-интеграции)
9. [MVP scope](#9-mvp-scope)
10. [Технологический стек](#10-технологический-стек)
11. [Риски и ограничения](#11-риски-и-ограничения)

---

## 1. Общее описание проекта и цели

### 1.1 Назначение

FoodOps -- приложение для оптимизации временных и финансовых затрат на ежедневную покупку продуктов питания для семей. Система охватывает полный цикл: от планирования меню на неделю до автоматической покупки продуктов в онлайн-магазине.

### 1.2 Проблема

Семьи ежедневно сталкиваются с рядом задач, связанных с питанием:

- **Планирование**: выбор блюд на каждый день с учётом предпочтений, ограничений и бюджета требует значительного времени (в среднем 3-5 часов в неделю).
- **Составление списка покупок**: ручной расчёт ингредиентов на неделю, проверка наличия продуктов дома, объединение ингредиентов из разных рецептов.
- **Покупка**: поиск товаров на сайте магазина, сравнение цен, добавление в корзину -- рутинный процесс, занимающий 30-60 минут за сеанс.

### 1.3 Решение

FoodOps автоматизирует все три этапа:

1. **Модуль планирования меню** -- AI-генерация персонализированного недельного меню.
2. **Модуль формирования списка продуктов** -- автоматический расчёт ингредиентов с привязкой к ассортименту конкретного магазина.
3. **Chrome Extension** -- автоматическое добавление товаров в корзину на сайте магазина.

### 1.4 Целевая аудитория

- Семьи из 2-6 человек.
- Географическая локация MVP: Хельсинки, Финляндия.
- Начальный магазин: S-Market (платформа foodie.fi).
- Возраст основного пользователя: 25-50 лет.
- Технически грамотные пользователи, комфортно использующие веб-приложения и браузерные расширения.

### 1.5 Бизнес-цели

| Цель                               | Метрика                         | Целевое значение (6 мес.)          |
| ---------------------------------- | ------------------------------- | ---------------------------------- |
| Сокращение времени на планирование | Среднее время планирования меню | < 10 минут в неделю                |
| Сокращение времени на покупки      | Среднее время онлайн-покупки    | < 5 минут в неделю                 |
| Экономия бюджета                   | Средняя экономия на продуктах   | 10-15% за счёт акций и оптимизации |
| Удовлетворённость пользователей    | NPS                             | > 40                               |
| Удержание пользователей            | Retention (месячный)            | > 60%                              |

---

## 2. Пользовательские сценарии (User Stories)

### 2.1 Регистрация и настройка профиля

| ID     | User Story                                                                                                                                                       | Приоритет |
| ------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------- |
| US-001 | Как новый пользователь, я хочу зарегистрироваться по email или через Google/Apple, чтобы получить доступ к системе.                                              | Высокий   |
| US-002 | Как пользователь, я хочу создать профиль семьи и добавить членов семьи (имя, возраст), чтобы система учитывала потребности каждого.                              | Высокий   |
| US-003 | Как пользователь, я хочу указать диетические ограничения для каждого члена семьи (аллергии, непереносимости, вегетарианство и т.д.), чтобы меню было безопасным. | Высокий   |
| US-004 | Как пользователь, я хочу указать медицинские ограничения (диабет, повышенный холестерин, гипертония), чтобы система предлагала подходящее меню.                  | Высокий   |
| US-005 | Как пользователь, я хочу задать предпочтения по кухне (финская, итальянская, азиатская и т.д.), чтобы меню соответствовало нашим вкусам.                         | Средний   |
| US-006 | Как пользователь, я хочу задать недельный бюджет на продукты, чтобы система оптимизировала меню под него.                                                        | Средний   |
| US-007 | Как пользователь, я хочу указать, какие продукты мы не любим или не хотим видеть в меню, чтобы исключить нежелательные ингредиенты.                              | Средний   |

### 2.2 Планирование меню

| ID     | User Story                                                                                                                                     | Приоритет |
| ------ | ---------------------------------------------------------------------------------------------------------------------------------------------- | --------- |
| US-010 | Как пользователь, я хочу нажать одну кнопку и получить меню на неделю с завтраками, обедами и ужинами, чтобы не тратить время на планирование. | Высокий   |
| US-011 | Как пользователь, я хочу видеть для каждого блюда: название, краткое описание, список ингредиентов, калорийность и примерную стоимость.        | Высокий   |
| US-012 | Как пользователь, я хочу заменить конкретное блюдо в меню на другое (перегенерировать или выбрать из предложенных альтернатив).                | Высокий   |
| US-013 | Как пользователь, я хочу зафиксировать понравившиеся блюда, чтобы при перегенерации они не менялись.                                           | Средний   |
| US-014 | Как пользователь, я хочу сохранять меню в историю и повторно использовать прошлые меню.                                                        | Средний   |
| US-015 | Как пользователь, я хочу видеть суммарную калорийность и стоимость меню на неделю.                                                             | Средний   |
| US-016 | Как пользователь, я хочу указать, сколько приёмов пищи в день нам нужно (2 или 3), чтобы система учитывала это при генерации.                  | Средний   |
| US-017 | Как пользователь, я хочу добавлять собственные рецепты в библиотеку системы.                                                                   | Низкий    |

### 2.3 Формирование списка продуктов

| ID     | User Story                                                                                                                                   | Приоритет |
| ------ | -------------------------------------------------------------------------------------------------------------------------------------------- | --------- |
| US-020 | Как пользователь, я хочу получить консолидированный список продуктов на основе утверждённого меню с указанием количества и единиц измерения. | Высокий   |
| US-021 | Как пользователь, я хочу видеть маппинг каждого продукта из списка на конкретный товар в S-Market с ценой.                                   | Высокий   |
| US-022 | Как пользователь, я хочу видеть общую стоимость корзины до покупки.                                                                          | Высокий   |
| US-023 | Как пользователь, я хочу вручную отредактировать список: удалить продукт, изменить количество, добавить свой продукт.                        | Высокий   |
| US-024 | Как пользователь, я хочу отметить продукты, которые уже есть дома, чтобы не покупать их повторно.                                            | Средний   |
| US-025 | Как пользователь, я хочу видеть предложенные замены, если товар отсутствует или вышел из ассортимента.                                       | Средний   |
| US-026 | Как пользователь, я хочу видеть товары по акции и предложения по замене на более выгодные аналоги.                                           | Средний   |

### 2.4 Автоматизация покупки (Chrome Extension)

| ID     | User Story                                                                                                                                                  | Приоритет |
| ------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------- | --------- |
| US-030 | Как пользователь, я хочу установить Chrome Extension и авторизоваться в нём через свой аккаунт FoodOps.                                                     | Высокий   |
| US-031 | Как пользователь, я хочу нажать кнопку "Добавить в корзину" в расширении, чтобы все товары из моего списка автоматически добавились в корзину на foodie.fi. | Высокий   |
| US-032 | Как пользователь, я хочу видеть прогресс добавления товаров в корзину (X из Y добавлено).                                                                   | Высокий   |
| US-033 | Как пользователь, я хочу видеть отчёт после добавления: какие товары добавлены успешно, какие не найдены, какие заменены.                                   | Высокий   |
| US-034 | Как пользователь, я хочу иметь возможность подтвердить или отклонить предложенные замены перед добавлением.                                                 | Средний   |
| US-035 | Как пользователь, я хочу, чтобы расширение не мешало моей обычной работе в браузере.                                                                        | Высокий   |

---

## 3. Функциональные требования

### 3.1 Модуль 1: Планирование меню на неделю

#### 3.1.1 Генерация меню

| ID     | Требование                        | Описание                                                                                                                                                                |
| ------ | --------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| FR-100 | Генерация полного недельного меню | Система должна генерировать меню на 7 дней, включающее от 2 до 3 приёмов пищи в день (настраивается пользователем). Каждый приём пищи содержит одно или несколько блюд. |
| FR-101 | Учёт профиля семьи                | При генерации меню система учитывает: количество членов семьи, возраст, диетические и медицинские ограничения каждого члена.                                            |
| FR-102 | Учёт предпочтений                 | Система учитывает: предпочитаемые типы кухни, исключённые продукты/ингредиенты, целевую калорийность, бюджетные ограничения.                                            |
| FR-103 | Разнообразие                      | Система не должна повторять одинаковые блюда в рамках одной недели. В рамках 4 недель подряд повторение допускается не более 20% блюд.                                  |
| FR-104 | Сезонность                        | Система должна учитывать сезонность продуктов для Финляндии (опционально, post-MVP).                                                                                    |

#### 3.1.2 Рецепты и блюда

| ID     | Требование               | Описание                                                                                                                                                                                                                               |
| ------ | ------------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| FR-110 | Карточка блюда           | Каждое блюдо содержит: название (на финском и английском), описание (1-2 предложения), список ингредиентов с количеством, время приготовления, калорийность (на порцию), категория кухни, теги (вегетарианское, безглютеновое и т.д.). |
| FR-111 | Масштабирование порций   | Количество ингредиентов автоматически масштабируется в зависимости от числа порций (= числа членов семьи).                                                                                                                             |
| FR-112 | Замена блюда             | Пользователь может заменить любое блюдо. Система предлагает 3-5 альтернатив, соответствующих тем же ограничениям.                                                                                                                      |
| FR-113 | Фиксация блюда           | Пользователь может "закрепить" блюдо, чтобы оно не менялось при перегенерации остального меню.                                                                                                                                         |
| FR-114 | Пользовательские рецепты | Пользователь может добавить собственный рецепт (название, ингредиенты, описание). Система включает его в пул при генерации меню.                                                                                                       |

#### 3.1.3 Сводная информация

| ID     | Требование             | Описание                                                                                    |
| ------ | ---------------------- | ------------------------------------------------------------------------------------------- |
| FR-120 | Калорийность на неделю | Отображение суммарной и средней дневной калорийности на семью и на человека.                |
| FR-121 | Стоимость на неделю    | Отображение расчётной стоимости всех продуктов для меню на неделю (на основе цен магазина). |
| FR-122 | Нутриентный баланс     | Отображение основных макронутриентов (белки, жиры, углеводы) в сводке по дням и по неделе.  |

### 3.2 Модуль 2: Формирование списка продуктов

#### 3.2.1 Консолидация ингредиентов

| ID     | Требование                  | Описание                                                                                                                                                                                                             |
| ------ | --------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| FR-200 | Автоматическая консолидация | Система объединяет одинаковые ингредиенты из разных рецептов в одну позицию списка с суммированием количества. Например, если 3 рецепта требуют лук (200г + 150г + 100г), в списке будет одна позиция "Лук -- 450г". |
| FR-201 | Нормализация единиц         | Система приводит единицы измерения к стандартным (граммы, миллилитры, штуки).                                                                                                                                        |
| FR-202 | Группировка по категориям   | Список группируется по категориям: молочные, мясо, овощи, фрукты, бакалея, заморозка, напитки, прочее.                                                                                                               |

#### 3.2.2 Маппинг на ассортимент магазина

| ID     | Требование                 | Описание                                                                                                                                                                                                                  |
| ------ | -------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| FR-210 | Автоматический маппинг     | Каждый ингредиент из списка автоматически сопоставляется с конкретным товаром (SKU) в каталоге S-Market.                                                                                                                  |
| FR-211 | Расчёт количества упаковок | Система рассчитывает, сколько упаковок товара нужно купить, исходя из требуемого количества ингредиента и фасовки товара. Пример: нужно 450г лука, в магазине лук продаётся сетками по 1кг -- система предлагает 1 сетку. |
| FR-212 | Цены и стоимость           | Для каждого товара отображается актуальная цена. Подсчитывается итоговая стоимость всей корзины.                                                                                                                          |
| FR-213 | Акции и спецпредложения    | Система выделяет товары, на которые действуют акции. При наличии акционного аналога система предлагает замену.                                                                                                            |
| FR-214 | Замены при отсутствии      | Если товар отсутствует в ассортименте, система предлагает 1-3 альтернативы с пояснением различий.                                                                                                                         |

#### 3.2.3 Редактирование списка

| ID     | Требование                   | Описание                                                                                                                            |
| ------ | ---------------------------- | ----------------------------------------------------------------------------------------------------------------------------------- |
| FR-220 | Удаление позиции             | Пользователь может удалить любую позицию из списка.                                                                                 |
| FR-221 | Изменение количества         | Пользователь может изменить количество для любой позиции.                                                                           |
| FR-222 | Добавление позиции           | Пользователь может добавить произвольный продукт (поиск по каталогу магазина).                                                      |
| FR-223 | Пометка "есть дома"          | Пользователь может пометить продукт как "уже есть дома". Такой продукт исключается из корзины, но остаётся в списке (для рецептов). |
| FR-224 | Выбор альтернативного товара | Для каждой позиции пользователь может переключиться на альтернативный товар из каталога.                                            |

### 3.3 Модуль 3: Chrome Extension для автоматизации покупки

#### 3.3.1 Авторизация и связь с аккаунтом

| ID     | Требование               | Описание                                                                                                       |
| ------ | ------------------------ | -------------------------------------------------------------------------------------------------------------- |
| FR-300 | Авторизация в расширении | Пользователь авторизуется в расширении через аккаунт FoodOps (OAuth2 flow, открытие popup с веб-авторизацией). |
| FR-301 | Синхронизация списка     | Расширение получает актуальный список продуктов из бэкенда FoodOps.                                            |
| FR-302 | Отображение списка       | В popup расширения отображается текущий список продуктов с количеством и стоимостью.                           |

#### 3.3.2 Автоматическое добавление в корзину

| ID     | Требование                          | Описание                                                                                                                                                                                                                                                                 |
| ------ | ----------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| FR-310 | Навигация на foodie.fi              | При нажатии кнопки "Добавить в корзину" расширение открывает/переключается на foodie.fi (если не открыт).                                                                                                                                                                |
| FR-311 | Проверка авторизации на foodie.fi   | Расширение проверяет, авторизован ли пользователь на foodie.fi. Если нет -- уведомляет пользователя о необходимости войти в аккаунт S-Market.                                                                                                                            |
| FR-312 | Последовательное добавление товаров | Расширение последовательно ищет каждый товар из списка на foodie.fi и добавляет его в корзину.                                                                                                                                                                           |
| FR-313 | Поиск товара                        | Для каждой позиции расширение выполняет поиск по названию товара (на финском) на foodie.fi.                                                                                                                                                                              |
| FR-314 | Выбор наиболее подходящего товара   | Из результатов поиска расширение выбирает товар, наиболее соответствующий позиции в списке (по названию, бренду, фасовке). Алгоритм приоритизации: точное совпадение EAN > совпадение названия + бренда > совпадение названия + фасовки > лучшее совпадение по названию. |
| FR-315 | Установка количества                | Расширение устанавливает правильное количество единиц товара в корзине.                                                                                                                                                                                                  |
| FR-316 | Прогресс                            | В popup расширения отображается прогресс-бар: "Добавлено X из Y товаров".                                                                                                                                                                                                |

#### 3.3.3 Отчёт и обработка ошибок

| ID     | Требование        | Описание                                                                                                                                                |
| ------ | ----------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------- |
| FR-320 | Отчёт об успехе   | После завершения процесса расширение показывает отчёт: список успешно добавленных товаров, товары с заменами (с указанием замены), не найденные товары. |
| FR-321 | Повторная попытка | Для не найденных товаров пользователь может выполнить повторный поиск с изменённым запросом.                                                            |
| FR-322 | Ручной выбор      | Для не найденных товаров пользователь может перейти на foodie.fi и добавить товар вручную.                                                              |
| FR-323 | Таймаут           | Если добавление одного товара занимает более 30 секунд, расширение пропускает его и отмечает как "не добавлен (таймаут)".                               |

---

## 4. Нефункциональные требования

### 4.1 Производительность

| ID      | Требование                               | Метрика                                                              |
| ------- | ---------------------------------------- | -------------------------------------------------------------------- |
| NFR-001 | Время генерации меню                     | Полное меню на неделю генерируется за < 15 секунд.                   |
| NFR-002 | Время формирования списка продуктов      | Список формируется за < 5 секунд после утверждения меню.             |
| NFR-003 | Время добавления одного товара в корзину | < 10 секунд на один товар (включая поиск и добавление на foodie.fi). |
| NFR-004 | Время загрузки веб-приложения            | First Contentful Paint < 2 секунды, Time to Interactive < 4 секунды. |
| NFR-005 | Время ответа API                         | 95-й перцентиль < 500 мс (исключая генерацию меню).                  |

### 4.2 Масштабируемость

| ID      | Требование                     | Описание                                                                              |
| ------- | ------------------------------ | ------------------------------------------------------------------------------------- |
| NFR-010 | Количество пользователей MVP   | Система поддерживает до 1 000 активных пользователей одновременно.                    |
| NFR-011 | Горизонтальное масштабирование | Архитектура бэкенда допускает горизонтальное масштабирование (stateless API-сервера). |
| NFR-012 | Масштабирование каталога       | Система должна работать с каталогом до 50 000 SKU.                                    |

### 4.3 Безопасность

| ID      | Требование                           | Описание                                                                                                                                                                                   |
| ------- | ------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| NFR-020 | Аутентификация                       | JWT-based аутентификация с access/refresh токенами. Access token TTL: 15 минут, refresh token TTL: 7 дней.                                                                                 |
| NFR-021 | Шифрование данных                    | Все данные передаются по HTTPS (TLS 1.2+). Пароли хранятся как bcrypt-хеши.                                                                                                                |
| NFR-022 | GDPR-соответствие                    | Система соответствует GDPR: возможность экспорта данных, удаление аккаунта, согласие на обработку данных.                                                                                  |
| NFR-023 | Ограничение запросов (Rate Limiting) | API: 100 запросов в минуту на пользователя. Генерация меню: 10 запросов в час на пользователя.                                                                                             |
| NFR-024 | Chrome Extension безопасность        | Расширение запрашивает минимально необходимые permissions. Не хранит токены foodie.fi. Коммуникация только через background script. Content script имеет доступ только к домену foodie.fi. |

### 4.4 Доступность и надёжность

| ID      | Требование            | Описание                                                                                                                                                                                                        |
| ------- | --------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| NFR-030 | Доступность сервиса   | Uptime не менее 99.5% (допускается ~3.6 часа простоя в месяц).                                                                                                                                                  |
| NFR-031 | Резервное копирование | Ежедневное автоматическое резервное копирование базы данных. Хранение бэкапов -- 30 дней.                                                                                                                       |
| NFR-032 | Graceful degradation  | При недоступности AI-сервиса система предлагает меню из предварительно сгенерированных шаблонов. При недоступности foodie.fi расширение уведомляет пользователя и предлагает экспорт списка в текстовый формат. |

### 4.5 Локализация

| ID      | Требование       | Описание                                                                                                   |
| ------- | ---------------- | ---------------------------------------------------------------------------------------------------------- |
| NFR-040 | Языки интерфейса | Английский (основной), финский (вторичный).                                                                |
| NFR-041 | Язык рецептов    | Рецепты хранятся на английском и финском. Названия товаров -- на финском (соответствие каталогу S-Market). |
| NFR-042 | Валюта           | Все цены в евро (EUR). Формат: X,XX EUR.                                                                   |

### 4.6 Совместимость

| ID      | Требование                 | Описание                                                                                              |
| ------- | -------------------------- | ----------------------------------------------------------------------------------------------------- |
| NFR-050 | Браузер (веб-приложение)   | Chrome 90+, Firefox 90+, Safari 15+, Edge 90+.                                                        |
| NFR-051 | Браузер (Chrome Extension) | Chrome 90+ (Manifest V3).                                                                             |
| NFR-052 | Мобильные устройства       | Веб-приложение -- responsive layout (поддержка экранов от 375px). Chrome Extension -- только desktop. |

---

## 5. Архитектурные компоненты системы

### 5.1 Обзор архитектуры

```
+-------------------------------------------------------------+
|                      КЛИЕНТСКИЙ УРОВЕНЬ                      |
|  +-------------------+   +-------------------------------+   |
|  | Web Application   |   | Chrome Extension              |   |
|  | (React SPA)       |   | (Manifest V3)                 |   |
|  |                   |   |  +----------+ +-------------+  |   |
|  | - Профиль семьи   |   |  | Popup UI | | Content     |  |   |
|  | - Меню            |   |  |          | | Script      |  |   |
|  | - Список продуктов|   |  +----------+ | (foodie.fi) |  |   |
|  |                   |   |  | Background Service Worker |  |   |
|  +--------+----------+   +------+------------------------+   |
|           |                      |                           |
+-----------+----------------------+---------------------------+
            |                      |
            v                      v
+-------------------------------------------------------------+
|                       API GATEWAY                            |
|  (Rate Limiting, Auth Middleware, Request Routing)            |
+------------------------------+------------------------------+
                               |
            +------------------+------------------+
            |                  |                  |
            v                  v                  v
+-------------------------------------------------------------+
|                     БЭКЕНД-СЕРВИСЫ                           |
|                                                              |
|  +--------------+  +---------------+  +------------------+   |
|  | Auth Service |  | Menu Service  |  | Shopping List     |   |
|  |              |  |               |  | Service           |   |
|  | - Регистрация|  | - Генерация   |  |                  |   |
|  | - Авторизация|  | - Замена блюд |  | - Консолидация   |   |
|  | - Профили    |  | - История     |  | - Маппинг товаров|   |
|  +--------------+  +-------+-------+  | - Цены           |   |
|                            |          +--------+---------+   |
|                            v                   |             |
|                    +---------------+           |             |
|                    | AI/ML Module  |           |             |
|                    |               |           v             |
|                    | - LLM API    |    +----------------+    |
|                    | - Prompt Eng.|    | Product Catalog |    |
|                    | - Validation |    | Service         |    |
|                    +---------------+   |                |    |
|                                        | - Каталог      |    |
|                                        | - Цены/акции   |    |
|                                        | - Поиск        |    |
|                                        +--------+-------+    |
|                                                 |            |
+-------------------------------------------------------------+
                               |
            +------------------+------------------+
            |                  |                  |
            v                  v                  v
+-------------------------------------------------------------+
|                    УРОВЕНЬ ДАННЫХ                             |
|                                                              |
|  +--------------+  +---------------+  +------------------+   |
|  | PostgreSQL   |  | Redis         |  | S3 / Object      |   |
|  | (основная БД)|  | (кеш, сессии) |  | Storage           |   |
|  +--------------+  +---------------+  +------------------+   |
+-------------------------------------------------------------+
                               |
                               v
+-------------------------------------------------------------+
|                   ВНЕШНИЕ ИНТЕГРАЦИИ                          |
|                                                              |
|  +---------------------+  +-----------------------------+    |
|  | OpenAI API /        |  | S-Market (foodie.fi)        |    |
|  | Anthropic API       |  | - Каталог товаров           |    |
|  | (генерация меню)    |  | - Цены и акции              |    |
|  +---------------------+  +-----------------------------+    |
+-------------------------------------------------------------+
```

### 5.2 Frontend -- Web Application

**Тип:** Single Page Application (SPA)

**Основные экраны:**

1. **Onboarding Flow**
   - Регистрация / Вход
   - Создание профиля семьи
   - Настройка ограничений и предпочтений

2. **Dashboard**
   - Текущее меню на неделю (если есть)
   - Быстрые действия: сгенерировать меню, открыть список, начать покупку
   - История заказов

3. **Menu Planner**
   - Календарная сетка (7 дней x 2-3 приёма пищи)
   - Карточки блюд с возможностью замены/фиксации
   - Боковая панель с деталями рецепта
   - Сводная информация (калории, стоимость, нутриенты)

4. **Shopping List**
   - Список продуктов, сгруппированный по категориям
   - Маппинг на товары S-Market с ценами
   - Интерфейс редактирования (удаление, количество, "есть дома")
   - Итоговая стоимость
   - Кнопка "Отправить в Chrome Extension"

5. **Settings**
   - Профиль семьи
   - Ограничения и предпочтения
   - Выбор магазина (в будущем)
   - Язык интерфейса
   - Удаление аккаунта

### 5.3 Chrome Extension

**Manifest Version:** V3

**Компоненты:**

| Компонент                     | Назначение                                                                                                                              |
| ----------------------------- | --------------------------------------------------------------------------------------------------------------------------------------- |
| **Background Service Worker** | Обмен сообщениями между popup и content script. Хранение состояния. Коммуникация с бэкендом FoodOps (получение списка).                 |
| **Popup UI**                  | Интерфейс расширения: авторизация, отображение списка, кнопка "Добавить в корзину", прогресс, отчёт.                                    |
| **Content Script**            | Внедряется на foodie.fi. Выполняет поиск товаров, добавление в корзину, чтение результатов поиска. Манипулирует DOM страницы foodie.fi. |
| **Options Page**              | Настройки расширения (опционально).                                                                                                     |

**Permissions:**

```json
{
  "permissions": ["storage", "activeTab", "tabs"],
  "host_permissions": ["https://www.foodie.fi/*", "https://api.foodops.app/*"],
  "content_scripts": [
    {
      "matches": ["https://www.foodie.fi/*"],
      "js": ["content-script.js"]
    }
  ]
}
```

**Рабочий процесс добавления товаров:**

```
1. Пользователь нажимает "Добавить в корзину" в popup
2. Background SW получает список из бэкенда FoodOps
3. Background SW проверяет наличие открытой вкладки foodie.fi
   - Если нет -- открывает новую вкладку
4. Background SW отправляет первый товар в Content Script
5. Content Script:
   a. Вводит поисковый запрос (название товара на финском)
   b. Ожидает загрузки результатов
   c. Ищет совпадение (по EAN, названию, бренду)
   d. Нажимает "Добавить в корзину" для найденного товара
   e. Устанавливает нужное количество
   f. Отправляет результат обратно в Background SW
6. Background SW обновляет прогресс в popup
7. Повторяется для следующего товара
8. По завершении -- формируется и отображается отчёт
```

### 5.4 Backend

**Тип:** RESTful API-сервер (monolith с модульной структурой, готовой к разделению на микросервисы).

**Модули:**

| Модуль          | Ответственность                                                                              |
| --------------- | -------------------------------------------------------------------------------------------- |
| `auth`          | Регистрация, авторизация (JWT), управление аккаунтами, OAuth2-провайдеры.                    |
| `family`        | Управление профилем семьи, члены семьи, ограничения и предпочтения.                          |
| `menu`          | Генерация меню, замена блюд, история меню, библиотека рецептов.                              |
| `shopping-list` | Консолидация ингредиентов, маппинг на товары, редактирование списка.                         |
| `catalog`       | Управление каталогом товаров S-Market, поиск товаров, цены и акции.                          |
| `extension-api` | API-эндпоинты, специфичные для Chrome Extension (получение списка в формате для расширения). |

### 5.5 AI/ML модуль

**Назначение:** Генерация персонализированного меню на основе профиля семьи.

**Подход:** Использование LLM (Large Language Model) через API (OpenAI GPT-4o / Anthropic Claude) с тщательно спроектированными промптами (prompt engineering).

**Архитектура промптов:**

```
System Prompt:
  - Роль: нутрициолог-повар, специализирующийся на семейном питании
  - Контекст: Финляндия, доступность продуктов
  - Формат выходных данных: структурированный JSON

User Prompt (динамический):
  - Профиль семьи (состав, возраст)
  - Диетические ограничения (по каждому члену)
  - Медицинские ограничения (по каждому члену)
  - Предпочтения по кухне
  - Бюджет
  - Исключённые продукты
  - Закреплённые блюда (если есть)
  - Количество приёмов пищи в день
```

**Валидация выходных данных AI:**

| Проверка       | Описание                                                                  |
| -------------- | ------------------------------------------------------------------------- |
| Структура JSON | Соответствие ожидаемой схеме (7 дней, правильное число приёмов пищи).     |
| Ограничения    | Ни одно блюдо не содержит исключённых ингредиентов / аллергенов.          |
| Калорийность   | Суточная калорийность в допустимых пределах (+-20% от целевой).           |
| Разнообразие   | Отсутствие повторений основных блюд в рамках недели.                      |
| Полнота        | Каждое блюдо имеет название, описание, список ингредиентов с количеством. |

При непрохождении валидации -- повторный запрос к LLM с указанием ошибок (до 3 попыток).

---

## 6. Модель данных

### 6.1 ER-диаграмма (основные сущности)

```
+----------------+       +------------------+       +----------------+
|     User       |       |     Family       |       | FamilyMember   |
+----------------+       +------------------+       +----------------+
| id (PK)        |1    1 | id (PK)          |1    * | id (PK)        |
| email          +-------+ user_id (FK)     +-------+ family_id (FK) |
| password_hash  |       | name             |       | name           |
| created_at     |       | created_at       |       | age            |
| updated_at     |       | weekly_budget    |       | role           |
| language       |       | meals_per_day    |       | created_at     |
+----------------+       +------------------+       +-------+--------+
                                                            |
                                                     +------+--------+
                                                     |               |
                                              +------+------+ +------+------+
                                              | DietaryRestr| | MedicalRestr|
                                              +-------------+ +-------------+
                                              | id (PK)     | | id (PK)     |
                                              | member_id   | | member_id   |
                                              | type        | | type        |
                                              | value       | | condition   |
                                              | severity    | | notes       |
                                              +-------------+ +-------------+


+----------------+       +------------------+       +----------------+
|   WeeklyMenu   |       |    MenuDay       |       |    Meal        |
+----------------+       +------------------+       +----------------+
| id (PK)        |1    * | id (PK)          |1    * | id (PK)        |
| family_id (FK) +-------+ menu_id (FK)     +-------+ menu_day_id    |
| week_start     |       | day_of_week      |       | meal_type      |
| status         |       | date             |       | recipe_id (FK) |
| total_cost     |       +------------------+       | is_locked      |
| total_calories |                                   | servings       |
| created_at     |                                   +-------+--------+
+----------------+                                           |
                                                             v
+----------------+       +------------------+       +----------------+
|    Recipe       |       |RecipeIngredient  |       |  Ingredient    |
+----------------+       +------------------+       +----------------+
| id (PK)        |1    * | id (PK)          |*    1 | id (PK)        |
| title_en       +-------+ recipe_id (FK)   +-------+ name_en        |
| title_fi       |       | ingredient_id    |       | name_fi        |
| description_en |       | quantity         |       | category       |
| description_fi |       | unit             |       | default_unit   |
| cuisine_type   |       | is_optional      |       +--------+-------+
| prep_time_min  |       +------------------+                |
| calories       |                                    +------+--------+
| protein        |                                    |               |
| carbs          |                                    v               v
| fat            |                            +------+------+ +------+------+
| tags (JSONB)   |                            |IngredientMap| |   Product   |
| is_custom      |                            +-------------+ +-------------+
| user_id (FK)   |                            | id (PK)     | | id (PK)     |
| source         |                            | ingredient  | | ean          |
+----------------+                            |   _id (FK)  | | name_fi     |
                                              | product     | | brand       |
                                              |   _id (FK)  | | price       |
                                              | confidence  | | unit_size   |
+----------------+       +------------------+ | is_default  | | unit_type   |
| ShoppingList   |       |ShoppingListItem  | +-------------+ | category    |
+----------------+       +------------------+                  | image_url   |
| id (PK)        |1    * | id (PK)          |                  | in_stock    |
| family_id (FK) +-------+ list_id (FK)     |                  | promo_price |
| menu_id (FK)   |       | ingredient_id    |                  | store_id    |
| status         |       | product_id (FK)  |                  | updated_at  |
| total_cost     |       | quantity_needed  |                  +-------------+
| created_at     |       | quantity_to_buy  |
+----------------+       | unit             |                  +-------------+
                          | has_at_home      |                  |    Store    |
                          | is_manual        |                  +-------------+
                          | status           |                  | id (PK)     |
                          +------------------+                  | name        |
                                                                | chain       |
                          +------------------+                  | address     |
                          |  Preference      |                  | city        |
                          +------------------+                  | catalog_url |
                          | id (PK)          |                  +-------------+
                          | family_id (FK)   |
                          | type             |
                          | value            |
                          +------------------+
```

### 6.2 Описание основных сущностей

#### User (Пользователь)

| Поле             | Тип          | Описание                                     |
| ---------------- | ------------ | -------------------------------------------- |
| id               | UUID         | Уникальный идентификатор                     |
| email            | VARCHAR(255) | Email (уникальный, используется для входа)   |
| password_hash    | VARCHAR(255) | Хеш пароля (bcrypt)                          |
| auth_provider    | VARCHAR(50)  | Провайдер авторизации (local, google, apple) |
| auth_provider_id | VARCHAR(255) | Идентификатор у провайдера                   |
| language         | VARCHAR(5)   | Язык интерфейса (en, fi)                     |
| created_at       | TIMESTAMP    | Дата регистрации                             |
| updated_at       | TIMESTAMP    | Дата последнего обновления                   |

#### Family (Семья)

| Поле               | Тип          | Описание                                |
| ------------------ | ------------ | --------------------------------------- |
| id                 | UUID         | Уникальный идентификатор                |
| user_id            | UUID (FK)    | Ссылка на пользователя-владельца        |
| name               | VARCHAR(100) | Название (например, "Семья Виртаненов") |
| weekly_budget      | DECIMAL(8,2) | Недельный бюджет на продукты (EUR)      |
| meals_per_day      | SMALLINT     | Количество приёмов пищи (2 или 3)       |
| preferred_store_id | UUID (FK)    | Предпочитаемый магазин                  |
| created_at         | TIMESTAMP    | Дата создания                           |

#### FamilyMember (Член семьи)

| Поле       | Тип          | Описание                    |
| ---------- | ------------ | --------------------------- |
| id         | UUID         | Уникальный идентификатор    |
| family_id  | UUID (FK)    | Ссылка на семью             |
| name       | VARCHAR(100) | Имя                         |
| age        | SMALLINT     | Возраст                     |
| role       | VARCHAR(20)  | Роль (adult, child, infant) |
| created_at | TIMESTAMP    | Дата создания               |

#### DietaryRestriction (Диетическое ограничение)

| Поле      | Тип          | Описание                                          |
| --------- | ------------ | ------------------------------------------------- |
| id        | UUID         | Уникальный идентификатор                          |
| member_id | UUID (FK)    | Ссылка на члена семьи                             |
| type      | VARCHAR(50)  | Тип ограничения (allergy, intolerance, lifestyle) |
| value     | VARCHAR(100) | Значение (gluten, lactose, nuts, vegan и т.д.)    |
| severity  | VARCHAR(20)  | Строгость (strict, moderate, mild)                |

#### MedicalRestriction (Медицинское ограничение)

| Поле      | Тип          | Описание                                                 |
| --------- | ------------ | -------------------------------------------------------- |
| id        | UUID         | Уникальный идентификатор                                 |
| member_id | UUID (FK)    | Ссылка на члена семьи                                    |
| condition | VARCHAR(100) | Условие (diabetes_type2, high_cholesterol, hypertension) |
| notes     | TEXT         | Дополнительные заметки                                   |

#### Preference (Предпочтение семьи)

| Поле      | Тип          | Описание                                            |
| --------- | ------------ | --------------------------------------------------- |
| id        | UUID         | Уникальный идентификатор                            |
| family_id | UUID (FK)    | Ссылка на семью                                     |
| type      | VARCHAR(50)  | Тип (cuisine, excluded_ingredient, favorite_recipe) |
| value     | VARCHAR(255) | Значение                                            |

#### Recipe (Рецепт)

| Поле                 | Тип                 | Описание                                      |
| -------------------- | ------------------- | --------------------------------------------- |
| id                   | UUID                | Уникальный идентификатор                      |
| title_en             | VARCHAR(255)        | Название (англ.)                              |
| title_fi             | VARCHAR(255)        | Название (фин.)                               |
| description_en       | TEXT                | Описание (англ.)                              |
| description_fi       | TEXT                | Описание (фин.)                               |
| cuisine_type         | VARCHAR(50)         | Тип кухни                                     |
| prep_time_min        | SMALLINT            | Время приготовления (мин.)                    |
| calories_per_serving | SMALLINT            | Калории на порцию                             |
| protein_per_serving  | DECIMAL(6,2)        | Белки на порцию (г)                           |
| carbs_per_serving    | DECIMAL(6,2)        | Углеводы на порцию (г)                        |
| fat_per_serving      | DECIMAL(6,2)        | Жиры на порцию (г)                            |
| tags                 | JSONB               | Теги (vegetarian, gluten_free, quick, и т.д.) |
| is_custom            | BOOLEAN             | Пользовательский рецепт?                      |
| user_id              | UUID (FK, nullable) | Автор (для пользовательских рецептов)         |
| source               | VARCHAR(500)        | Источник рецепта (URL или описание)           |

#### Product (Товар S-Market)

| Поле              | Тип          | Описание                          |
| ----------------- | ------------ | --------------------------------- |
| id                | UUID         | Уникальный идентификатор          |
| ean               | VARCHAR(20)  | Штрих-код (EAN-13)                |
| name_fi           | VARCHAR(500) | Название на финском               |
| brand             | VARCHAR(255) | Бренд                             |
| price             | DECIMAL(8,2) | Текущая цена (EUR)                |
| promo_price       | DECIMAL(8,2) | Акционная цена (если есть)        |
| promo_end_date    | DATE         | Дата окончания акции              |
| unit_size         | DECIMAL(8,2) | Размер упаковки                   |
| unit_type         | VARCHAR(20)  | Единица (g, kg, ml, l, pcs)       |
| category          | VARCHAR(100) | Категория товара                  |
| subcategory       | VARCHAR(100) | Подкатегория                      |
| image_url         | VARCHAR(500) | URL изображения                   |
| in_stock          | BOOLEAN      | В наличии?                        |
| store_id          | UUID (FK)    | Ссылка на магазин                 |
| foodie_product_id | VARCHAR(100) | Идентификатор на foodie.fi        |
| updated_at        | TIMESTAMP    | Дата последнего обновления данных |

#### WeeklyMenu (Недельное меню)

| Поле                | Тип          | Описание                           |
| ------------------- | ------------ | ---------------------------------- |
| id                  | UUID         | Уникальный идентификатор           |
| family_id           | UUID (FK)    | Ссылка на семью                    |
| week_start          | DATE         | Дата начала недели (понедельник)   |
| status              | VARCHAR(20)  | Статус (draft, approved, archived) |
| total_cost_estimate | DECIMAL(8,2) | Расчётная стоимость                |
| total_calories      | INTEGER      | Суммарная калорийность             |
| created_at          | TIMESTAMP    | Дата создания                      |

#### ShoppingList (Список покупок)

| Поле       | Тип          | Описание                                  |
| ---------- | ------------ | ----------------------------------------- |
| id         | UUID         | Уникальный идентификатор                  |
| family_id  | UUID (FK)    | Ссылка на семью                           |
| menu_id    | UUID (FK)    | Ссылка на меню                            |
| status     | VARCHAR(20)  | Статус (draft, ready, in_cart, completed) |
| total_cost | DECIMAL(8,2) | Итоговая стоимость                        |
| created_at | TIMESTAMP    | Дата создания                             |

#### ShoppingListItem (Позиция списка покупок)

| Поле                | Тип                 | Описание                                             |
| ------------------- | ------------------- | ---------------------------------------------------- |
| id                  | UUID                | Уникальный идентификатор                             |
| list_id             | UUID (FK)           | Ссылка на список                                     |
| ingredient_id       | UUID (FK, nullable) | Ссылка на ингредиент (null для ручных добавлений)    |
| product_id          | UUID (FK)           | Ссылка на товар в магазине                           |
| quantity_needed     | DECIMAL(8,2)        | Необходимое количество ингредиента                   |
| quantity_to_buy     | DECIMAL(8,2)        | Количество упаковок к покупке                        |
| unit                | VARCHAR(20)         | Единица измерения                                    |
| has_at_home         | BOOLEAN             | Отмечено как "есть дома"                             |
| is_manual           | BOOLEAN             | Добавлено вручную                                    |
| status              | VARCHAR(20)         | Статус (pending, added_to_cart, not_found, replaced) |
| replaced_product_id | UUID (FK, nullable) | Товар-замена (если был заменён)                      |

---

## 7. API контракты

### 7.1 Общие соглашения

- **Базовый URL:** `https://api.foodops.app/v1`
- **Формат:** JSON
- **Аутентификация:** Bearer token (JWT) в заголовке `Authorization`
- **Пагинация:** cursor-based (`?cursor=xxx&limit=20`)
- **Ошибки:** стандартный формат

```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Human-readable message",
    "details": [{ "field": "email", "message": "Invalid email format" }]
  }
}
```

**HTTP коды:**

| Код | Значение                  |
| --- | ------------------------- |
| 200 | Успешный ответ            |
| 201 | Ресурс создан             |
| 400 | Ошибка валидации          |
| 401 | Не авторизован            |
| 403 | Доступ запрещён           |
| 404 | Ресурс не найден          |
| 429 | Превышен лимит запросов   |
| 500 | Внутренняя ошибка сервера |

### 7.2 Auth API

#### POST /auth/register

Регистрация нового пользователя.

**Request:**

```json
{
  "email": "user@example.com",
  "password": "securePassword123",
  "language": "en"
}
```

**Response (201):**

```json
{
  "user": {
    "id": "uuid",
    "email": "user@example.com",
    "language": "en",
    "created_at": "2026-02-09T12:00:00Z"
  },
  "tokens": {
    "access_token": "eyJhbG...",
    "refresh_token": "eyJhbG...",
    "expires_in": 900
  }
}
```

#### POST /auth/login

**Request:**

```json
{
  "email": "user@example.com",
  "password": "securePassword123"
}
```

**Response (200):**

```json
{
  "user": {
    "id": "uuid",
    "email": "user@example.com",
    "language": "en"
  },
  "tokens": {
    "access_token": "eyJhbG...",
    "refresh_token": "eyJhbG...",
    "expires_in": 900
  }
}
```

#### POST /auth/refresh

**Request:**

```json
{
  "refresh_token": "eyJhbG..."
}
```

**Response (200):**

```json
{
  "access_token": "eyJhbG...",
  "refresh_token": "eyJhbG...",
  "expires_in": 900
}
```

#### POST /auth/oauth/{provider}

OAuth авторизация (Google, Apple).

**Request:**

```json
{
  "id_token": "oauth_id_token_from_provider"
}
```

### 7.3 Family API

#### POST /family

Создание профиля семьи.

**Request:**

```json
{
  "name": "Virtanen Family",
  "weekly_budget": 150.0,
  "meals_per_day": 3,
  "preferred_store_id": "uuid"
}
```

**Response (201):**

```json
{
  "id": "uuid",
  "name": "Virtanen Family",
  "weekly_budget": 150.0,
  "meals_per_day": 3,
  "preferred_store_id": "uuid",
  "members": [],
  "preferences": [],
  "created_at": "2026-02-09T12:00:00Z"
}
```

#### GET /family

Получение профиля семьи текущего пользователя.

#### PUT /family

Обновление профиля семьи.

#### POST /family/members

Добавление члена семьи.

**Request:**

```json
{
  "name": "Matti",
  "age": 35,
  "role": "adult",
  "dietary_restrictions": [{ "type": "allergy", "value": "nuts", "severity": "strict" }],
  "medical_restrictions": [{ "condition": "high_cholesterol", "notes": "On medication" }]
}
```

#### PUT /family/members/{memberId}

Обновление данных члена семьи.

#### DELETE /family/members/{memberId}

Удаление члена семьи.

#### PUT /family/preferences

Обновление предпочтений семьи.

**Request:**

```json
{
  "cuisines": ["finnish", "italian", "asian"],
  "excluded_ingredients": ["cilantro", "blue_cheese"],
  "calorie_target_per_person": 2000
}
```

### 7.4 Menu API

#### POST /menu/generate

Генерация нового меню на неделю.

**Request:**

```json
{
  "week_start": "2026-02-09",
  "locked_meals": [
    {
      "day": 1,
      "meal_type": "dinner",
      "recipe_id": "uuid"
    }
  ]
}
```

**Response (200):**

```json
{
  "id": "uuid",
  "week_start": "2026-02-09",
  "status": "draft",
  "days": [
    {
      "day_of_week": 1,
      "date": "2026-02-09",
      "meals": [
        {
          "id": "uuid",
          "meal_type": "breakfast",
          "is_locked": false,
          "recipe": {
            "id": "uuid",
            "title_en": "Oatmeal with Berries",
            "title_fi": "Marjapuuro",
            "description_en": "Warm oatmeal topped with fresh berries and honey",
            "cuisine_type": "finnish",
            "prep_time_min": 15,
            "calories_per_serving": 350,
            "protein_per_serving": 12.5,
            "carbs_per_serving": 55.0,
            "fat_per_serving": 8.0,
            "tags": ["vegetarian", "quick"],
            "ingredients": [
              {
                "ingredient_id": "uuid",
                "name_en": "Rolled oats",
                "name_fi": "Kaurahiutale",
                "quantity": 80,
                "unit": "g",
                "is_optional": false
              }
            ]
          },
          "servings": 4
        }
      ]
    }
  ],
  "summary": {
    "total_calories": 56000,
    "avg_daily_calories_per_person": 2000,
    "total_cost_estimate": 127.5,
    "macros": {
      "protein_pct": 25,
      "carbs_pct": 50,
      "fat_pct": 25
    }
  }
}
```

#### POST /menu/{menuId}/regenerate-meal

Перегенерация одного приёма пищи.

**Request:**

```json
{
  "day": 3,
  "meal_type": "dinner"
}
```

**Response (200):** Массив из 3-5 альтернативных рецептов.

#### PUT /menu/{menuId}/meals/{mealId}

Замена блюда в меню.

**Request:**

```json
{
  "recipe_id": "uuid-of-new-recipe"
}
```

#### PUT /menu/{menuId}/meals/{mealId}/lock

Закрепление/открепление блюда.

**Request:**

```json
{
  "is_locked": true
}
```

#### PUT /menu/{menuId}/approve

Утверждение меню (переход из draft в approved).

#### GET /menu/history

Получение истории меню.

**Query:** `?cursor=xxx&limit=10`

#### GET /menu/{menuId}

Получение конкретного меню.

### 7.5 Shopping List API

#### POST /shopping-list/generate

Генерация списка покупок из утверждённого меню.

**Request:**

```json
{
  "menu_id": "uuid"
}
```

**Response (201):**

```json
{
  "id": "uuid",
  "menu_id": "uuid",
  "status": "draft",
  "categories": [
    {
      "name": "Молочные продукты",
      "items": [
        {
          "id": "uuid",
          "ingredient": {
            "id": "uuid",
            "name_en": "Whole milk",
            "name_fi": "Täysmaito"
          },
          "quantity_needed": 2.5,
          "unit": "l",
          "product": {
            "id": "uuid",
            "ean": "6410405082657",
            "name_fi": "Valio täysmaito 1l",
            "brand": "Valio",
            "price": 1.29,
            "promo_price": null,
            "unit_size": 1.0,
            "unit_type": "l",
            "image_url": "https://...",
            "in_stock": true
          },
          "quantity_to_buy": 3,
          "line_total": 3.87,
          "has_at_home": false,
          "alternatives": [
            {
              "product_id": "uuid",
              "name_fi": "Arla täysmaito 1l",
              "price": 1.19,
              "reason": "Дешевле"
            }
          ]
        }
      ]
    }
  ],
  "total_cost": 127.5,
  "items_count": 42
}
```

#### GET /shopping-list/{listId}

Получение списка покупок.

#### PUT /shopping-list/{listId}/items/{itemId}

Обновление позиции списка.

**Request:**

```json
{
  "quantity_to_buy": 2,
  "product_id": "uuid-of-alternative",
  "has_at_home": false
}
```

#### DELETE /shopping-list/{listId}/items/{itemId}

Удаление позиции из списка.

#### POST /shopping-list/{listId}/items

Ручное добавление продукта.

**Request:**

```json
{
  "product_id": "uuid",
  "quantity_to_buy": 1
}
```

#### PUT /shopping-list/{listId}/ready

Пометка списка как готового для покупки.

### 7.6 Product Catalog API

#### GET /products/search

Поиск товаров в каталоге.

**Query:** `?q=maito&category=dairy&limit=20`

**Response (200):**

```json
{
  "products": [
    {
      "id": "uuid",
      "ean": "6410405082657",
      "name_fi": "Valio täysmaito 1l",
      "brand": "Valio",
      "price": 1.29,
      "promo_price": null,
      "unit_size": 1.0,
      "unit_type": "l",
      "category": "dairy",
      "image_url": "https://...",
      "in_stock": true
    }
  ],
  "total": 15
}
```

#### GET /products/{productId}

Получение детальной информации о товаре.

#### GET /products/promotions

Получение текущих акций.

**Query:** `?category=all&limit=50`

### 7.7 Extension API

#### GET /extension/shopping-list

Получение списка покупок в формате, оптимизированном для Chrome Extension.

**Response (200):**

```json
{
  "list_id": "uuid",
  "store": {
    "name": "S-Market",
    "website": "https://www.foodie.fi"
  },
  "items": [
    {
      "id": "uuid",
      "search_query_fi": "Valio täysmaito 1l",
      "ean": "6410405082657",
      "product_name_fi": "Valio täysmaito 1l",
      "brand": "Valio",
      "quantity": 3,
      "unit_size": "1l",
      "fallback_search_queries": ["täysmaito 1l", "täysmaito"],
      "category": "dairy"
    }
  ],
  "total_items": 42
}
```

#### POST /extension/shopping-list/{listId}/report

Отправка отчёта о результатах добавления в корзину.

**Request:**

```json
{
  "items": [
    {
      "item_id": "uuid",
      "status": "added",
      "foodie_product_id": "12345",
      "actual_price": 1.29
    },
    {
      "item_id": "uuid",
      "status": "replaced",
      "original_search": "Valio täysmaito 1l",
      "replacement_name": "Arla täysmaito 1l",
      "actual_price": 1.19
    },
    {
      "item_id": "uuid",
      "status": "not_found",
      "search_attempts": ["Luomu ruisleipä", "ruisleipä luomu"]
    }
  ]
}
```

### 7.8 Recipe API

#### GET /recipes/search

Поиск рецептов.

**Query:** `?q=pasta&cuisine=italian&tags=vegetarian&limit=20`

#### POST /recipes

Создание пользовательского рецепта.

**Request:**

```json
{
  "title_en": "Grandma's Meatballs",
  "title_fi": "Mummon lihapullat",
  "description_en": "Traditional Finnish meatballs",
  "cuisine_type": "finnish",
  "prep_time_min": 45,
  "calories_per_serving": 450,
  "tags": ["traditional"],
  "ingredients": [
    {
      "name_en": "Ground beef",
      "name_fi": "Jauheliha",
      "quantity": 500,
      "unit": "g"
    }
  ]
}
```

#### GET /recipes/{recipeId}

Получение рецепта.

#### PUT /recipes/{recipeId}

Обновление пользовательского рецепта.

#### DELETE /recipes/{recipeId}

Удаление пользовательского рецепта.

---

## 8. Интеграции

### 8.1 S-Market / foodie.fi

#### 8.1.1 Получение каталога товаров

**Задача:** Получить и поддерживать актуальный каталог товаров S-Market для региона Хельсинки.

**Подходы (по приоритету):**

| Приоритет | Подход                  | Описание                                                                                                                                                                    |
| --------- | ----------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1         | Официальный API         | Связаться с S Group / SOK для получения доступа к API каталога. Наилучший вариант -- стабильный, легальный, структурированные данные.                                       |
| 2         | Foodie.fi Open Data     | Проверить наличие открытых данных или партнёрской программы на foodie.fi.                                                                                                   |
| 3         | Web Scraping            | Парсинг каталога с foodie.fi. Требуется: соблюдение robots.txt, ограничение частоты запросов, обработка изменений структуры страниц. Юридические риски -- требуется оценка. |
| 4         | Ручной ввод + Community | Начальный каталог вводится вручную (основные продукты). Далее расширяется через community contributions и парсинг.                                                          |

**Данные для импорта:**

- Название товара (финский)
- EAN (штрих-код)
- Бренд
- Цена
- Размер упаковки, единица измерения
- Категория
- Изображение
- Наличие
- Акции

**Частота обновления:**

- Цены и наличие: ежедневно (или чаще, если доступно)
- Базовый каталог (новые товары): еженедельно
- Акции: ежедневно

#### 8.1.2 Chrome Extension и foodie.fi

Chrome Extension взаимодействует с foodie.fi через Content Script, который манипулирует DOM страницы.

**Ключевые взаимодействия:**

| Действие             | Механизм                                                      |
| -------------------- | ------------------------------------------------------------- |
| Поиск товара         | Ввод текста в поле поиска на foodie.fi, ожидание результатов  |
| Чтение результатов   | Парсинг DOM результатов поиска (название, цена, EAN, наличие) |
| Добавление в корзину | Клик по кнопке "Добавить в корзину" для найденного товара     |
| Установка количества | Изменение количества в интерфейсе корзины                     |
| Проверка авторизации | Проверка наличия элементов авторизованного пользователя в DOM |

**Риски:**

- Изменение структуры DOM foodie.fi потребует обновления Content Script.
- Рекомендуется абстрагировать DOM-селекторы в конфигурационный файл для быстрого обновления.
- Необходимо добавление задержек между действиями для имитации реального пользователя и избежания блокировки.

### 8.2 AI для генерации меню

#### 8.2.1 Выбор LLM-провайдера

| Провайдер       | Модель            | Преимущества                                                                   | Недостатки                                 |
| --------------- | ----------------- | ------------------------------------------------------------------------------ | ------------------------------------------ |
| **OpenAI**      | GPT-4o            | Высокое качество генерации, хорошее следование инструкциям, Structured Outputs | Стоимость, зависимость от внешнего сервиса |
| **Anthropic**   | Claude 3.5 Sonnet | Хорошее следование сложным инструкциям, большое контекстное окно               | Стоимость                                  |
| **Open-source** | Llama 3 / Mixtral | Нет зависимости от внешних API, контроль данных                                | Требует инфраструктуры, ниже качество      |

**Рекомендация для MVP:** OpenAI GPT-4o с Structured Outputs для гарантированного JSON-формата. Абстрагировать LLM-провайдер через интерфейс для возможности переключения.

#### 8.2.2 Структура промпта

**System prompt (сокращённый пример):**

```
You are a professional family nutritionist and chef specializing in Finnish
and international cuisine. Your task is to create a weekly meal plan.

Output format: JSON (schema provided below).
Language: Recipe titles in both English and Finnish.
         Ingredient names in both English and Finnish.

Rules:
1. Respect ALL dietary and medical restrictions strictly.
2. Ensure nutritional balance across the week.
3. Prefer seasonal ingredients available in Finnish stores.
4. Keep total cost within the specified budget.
5. Ensure variety -- no repeated main dishes within the week.
6. Each recipe must include complete ingredient list with quantities.
7. Provide accurate calorie and macronutrient estimates.

JSON Schema:
{...schema...}
```

**User prompt (динамический, собирается из профиля семьи):**

```
Family profile:
- Members: [Matti (35, adult), Liisa (33, adult), Elias (7, child), Aino (4, child)]
- Dietary restrictions: Matti - nut allergy (strict), Elias - lactose intolerance (moderate)
- Medical restrictions: Liisa - high cholesterol
- Preferred cuisines: Finnish, Italian, Asian
- Excluded ingredients: blue cheese, cilantro
- Weekly budget: 150 EUR
- Meals per day: 3 (breakfast, lunch, dinner)
- Calorie target: ~2000 kcal/person/day (adults), ~1500 kcal/person/day (children)

Locked meals (do not change):
- Monday dinner: Lohikeitto (Salmon soup) [recipe_id: xxx]

Generate a complete weekly meal plan for Monday to Sunday.
```

#### 8.2.3 Оценка стоимости API

| Параметр                                        | Значение                 |
| ----------------------------------------------- | ------------------------ |
| Токены на запрос (input)                        | ~2 000                   |
| Токены на ответ (output)                        | ~4 000                   |
| Стоимость за запрос (GPT-4o)                    | ~$0.03                   |
| Среднее число запросов на пользователя в неделю | 2-3 (генерация + замены) |
| Стоимость на 1000 пользователей в месяц         | ~$360-540                |

---

## 9. MVP Scope

### 9.1 Что входит в MVP (v1.0)

#### Модуль 1: Планирование меню

- [x] Регистрация и авторизация (email + password)
- [x] Создание профиля семьи (до 6 членов)
- [x] Указание диетических ограничений (аллергии, непереносимости, вегетарианство)
- [x] Указание медицинских ограничений (базовый набор: диабет, холестерин, гипертония)
- [x] Указание предпочтений по кухне
- [x] Генерация меню на неделю (3 приёма пищи)
- [x] Просмотр карточек блюд (название, описание, ингредиенты, калорийность)
- [x] Замена отдельного блюда (регенерация)
- [x] Фиксация блюд
- [x] Утверждение меню
- [x] Суммарная калорийность и стоимость

#### Модуль 2: Список продуктов

- [x] Автоматическая генерация консолидированного списка из меню
- [x] Маппинг ингредиентов на товары S-Market (Хельсинки)
- [x] Расчёт количества упаковок и стоимости
- [x] Редактирование списка (удаление, изменение количества)
- [x] Пометка "есть дома"
- [x] Общая стоимость корзины

#### Модуль 3: Chrome Extension

- [x] Авторизация через FoodOps
- [x] Просмотр списка в popup
- [x] Автоматическое добавление товаров в корзину на foodie.fi
- [x] Прогресс добавления
- [x] Отчёт (добавлено / не найдено)

#### Инфраструктура

- [x] Развёртывание бэкенда (cloud)
- [x] PostgreSQL база данных
- [x] Начальный каталог товаров S-Market (top-500 товаров)
- [x] Мониторинг и логирование (базовый уровень)

### 9.2 Что НЕ входит в MVP (отложено на v2.0+)

| Функция                                            | Версия |
| -------------------------------------------------- | ------ |
| OAuth авторизация (Google, Apple)                  | v1.1   |
| Пользовательские рецепты                           | v1.1   |
| Полный каталог S-Market (50 000+ SKU)              | v1.1   |
| Акции и спецпредложения                            | v1.1   |
| Интеллектуальные замены (при отсутствии)           | v1.1   |
| Нутриентный баланс (белки/жиры/углеводы)           | v1.2   |
| Сезонность продуктов                               | v1.2   |
| Недельный бюджет-оптимизация                       | v1.2   |
| Второй магазин (Prisma, K-Market)                  | v2.0   |
| Мобильное приложение (React Native)                | v2.0   |
| Совместное редактирование меню (multi-user семья)  | v2.0   |
| Интеграция с delivery-сервисами (Wolt, Foodora)    | v2.0   |
| Экспорт рецептов (PDF, распечатка)                 | v1.2   |
| История покупок и аналитика расходов               | v2.0   |
| Социальные функции (обмен рецептами между семьями) | v3.0   |

### 9.3 Критерии готовности MVP

| Критерий              | Описание                                                                                    |
| --------------------- | ------------------------------------------------------------------------------------------- |
| Полный цикл           | Пользователь может пройти путь от регистрации до добавления товаров в корзину на foodie.fi. |
| Качество меню         | > 80% пользователей удовлетворены первой генерацией (не требуется более 3 замен).           |
| Точность маппинга     | > 85% ингредиентов корректно маппятся на товары S-Market.                                   |
| Успешность добавления | > 90% товаров из списка успешно добавляются в корзину на foodie.fi.                         |
| Стабильность          | Отсутствие critical/blocker багов. Error rate < 1% для API.                                 |

---

## 10. Технологический стек

### 10.1 Рекомендуемый стек

#### Frontend (Web Application)

| Компонент             | Технология                         | Обоснование                                                                              |
| --------------------- | ---------------------------------- | ---------------------------------------------------------------------------------------- |
| Framework             | **Next.js 14+ (App Router)**       | SSR/SSG для SEO, файловый роутинг, серверные компоненты, отличная DX                     |
| Язык                  | **TypeScript**                     | Типобезопасность, лучшая поддержка IDE, меньше runtime-ошибок                            |
| UI-библиотека         | **shadcn/ui + Tailwind CSS**       | Кастомизируемые компоненты, отсутствие vendor lock-in, consistent design                 |
| Управление состоянием | **Zustand** или **TanStack Query** | Zustand -- лёгкий store для UI-состояния. TanStack Query -- кеширование серверных данных |
| Формы                 | **React Hook Form + Zod**          | Производительные формы, валидация на уровне схемы                                        |
| Drag & Drop (меню)    | **dnd-kit**                        | Лёгкая библиотека для перетаскивания блюд в календарной сетке                            |

#### Chrome Extension

| Компонент      | Технология                                     | Обоснование                                 |
| -------------- | ---------------------------------------------- | ------------------------------------------- |
| Manifest       | **V3**                                         | Требование Chrome Web Store (V2 deprecated) |
| Popup UI       | **React + TypeScript**                         | Единый стек с основным приложением          |
| Сборка         | **Vite** или **webpack** с `crxjs/vite-plugin` | Удобная разработка расширений               |
| Content Script | **TypeScript (vanilla)**                       | Минимальный бандл для инъекции на foodie.fi |
| Тестирование   | **Puppeteer** / **Playwright**                 | E2E тесты взаимодействия с foodie.fi        |

#### Backend

| Компонент      | Технология                           | Обоснование                                                                                                |
| -------------- | ------------------------------------ | ---------------------------------------------------------------------------------------------------------- |
| Runtime        | **Node.js 20 LTS**                   | Единый язык с фронтендом, большая экосистема                                                               |
| Framework      | **Fastify** или **NestJS**           | Fastify -- высокая производительность, низкий overhead. NestJS -- архитектурная строгость, DI, модульность |
| Язык           | **TypeScript**                       | Типобезопасность, единый стек                                                                              |
| ORM            | **Prisma**                           | Типобезопасные запросы, миграции, отличная DX                                                              |
| Валидация      | **Zod**                              | Общая библиотека валидации frontend/backend                                                                |
| Аутентификация | **Passport.js** + JWT (jsonwebtoken) | Поддержка множества стратегий                                                                              |
| Очередь задач  | **BullMQ** (Redis)                   | Фоновые задачи: обновление каталога, AI-запросы                                                            |

#### База данных и кеширование

| Компонент            | Технология                                          | Обоснование                                                          |
| -------------------- | --------------------------------------------------- | -------------------------------------------------------------------- |
| Основная БД          | **PostgreSQL 16**                                   | Реляционная модель, JSONB для гибких полей, полнотекстовый поиск     |
| Кеш                  | **Redis 7**                                         | Кеширование каталога, сессии, rate limiting, очередь задач           |
| Полнотекстовый поиск | **PostgreSQL FTS** (MVP) / **Elasticsearch** (v2.0) | PostgreSQL FTS достаточен для MVP, Elasticsearch при масштабировании |

#### AI/ML

| Компонент         | Технология                                      | Обоснование                             |
| ----------------- | ----------------------------------------------- | --------------------------------------- |
| LLM-провайдер     | **OpenAI API** (GPT-4o)                         | Structured Outputs, высокое качество    |
| SDK               | **openai (npm)**                                | Официальный SDK                         |
| Промпт-менеджмент | Файлы-шаблоны + **Handlebars** или **LiquidJS** | Версионирование и тестирование промптов |
| Fallback          | Шаблонные меню (JSON-файлы)                     | При недоступности AI                    |

#### Инфраструктура

| Компонент      | Технология                                                              | Обоснование                                                                            |
| -------------- | ----------------------------------------------------------------------- | -------------------------------------------------------------------------------------- |
| Хостинг (app)  | **Vercel** (frontend) + **Railway** / **Render** / **Fly.io** (backend) | Vercel -- нативная поддержка Next.js. Railway/Render -- managed containers для бэкенда |
| БД хостинг     | **Neon** (Serverless PostgreSQL) или **Supabase**                       | Serverless PostgreSQL, бесплатный tier для MVP                                         |
| Кеш хостинг    | **Upstash** (Serverless Redis)                                          | Serverless Redis, бесплатный tier                                                      |
| Object Storage | **AWS S3** / **Cloudflare R2**                                          | Хранение изображений товаров                                                           |
| CI/CD          | **GitHub Actions**                                                      | Автоматическая сборка, тесты, деплой                                                   |
| Мониторинг     | **Sentry** (ошибки) + **Axiom** / **Better Stack** (логи)               | Отслеживание ошибок и метрик                                                           |

### 10.2 Альтернативный стек (Python-based backend)

При наличии в команде Python-экспертизы:

| Компонент | Технология                       |
| --------- | -------------------------------- |
| Framework | **FastAPI**                      |
| ORM       | **SQLAlchemy 2.0** + **Alembic** |
| Очередь   | **Celery** + Redis               |
| Валидация | **Pydantic v2**                  |

---

## 11. Риски и ограничения

### 11.1 Технические риски

| Риск                                                                                                                               | Вероятность | Влияние     | Митигация                                                                                                                                                                                 |
| ---------------------------------------------------------------------------------------------------------------------------------- | ----------- | ----------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Изменение DOM foodie.fi** -- структура страниц foodie.fi может измениться без предупреждения, сломав Content Script              | Высокая     | Критическое | Абстрагировать DOM-селекторы в конфигурационный файл. Мониторинг работоспособности расширения. Автоматические тесты против foodie.fi. Быстрый release pipeline для обновления расширения. |
| **Блокировка Chrome Extension** -- foodie.fi может заблокировать автоматизированные действия (rate limiting, CAPTCHA, block)       | Средняя     | Критическое | Добавить реалистичные задержки между действиями (2-5 сек). Не превышать разумное количество действий за сессию. Исследовать партнёрство с S Group.                                        |
| **Качество генерации AI** -- LLM может генерировать некорректные рецепты, нереалистичные сочетания, неточные калории               | Средняя     | Высокое     | Многоуровневая валидация выходных данных. Retry-механизм (до 3 попыток). Fallback на шаблонные меню. Система оценки и обратной связи от пользователей.                                    |
| **Неточный маппинг ингредиентов на товары** -- ингредиент "молоко" может некорректно сопоставиться с конкретным товаром в S-Market | Средняя     | Среднее     | Ручная курация маппинга для top-500 товаров. Алгоритм fuzzy matching. Возможность ручной коррекции пользователем. Постепенное улучшение на основе пользовательских данных.                |
| **Неполнота каталога** -- начальный каталог (500 товаров) может не покрывать все ингредиенты из рецептов                           | Высокая     | Среднее     | Генерировать рецепты с учётом имеющегося каталога (передавать список доступных категорий в промпт). Предусмотреть UI для "товар не найден -- добавьте вручную".                           |
| **Latency при генерации меню** -- LLM API может отвечать медленно (> 15 сек)                                                       | Средняя     | Среднее     | Стриминг ответа (SSE). Предзагрузка шаблонных вариантов. Оптимизация промптов для уменьшения размера ответа.                                                                              |

### 11.2 Юридические риски

| Риск                            | Описание                                                                                               | Митигация                                                                                                                                                      |
| ------------------------------- | ------------------------------------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Парсинг foodie.fi**           | Web scraping каталога может нарушать Terms of Service.                                                 | Приоритет -- получение официального API доступа. Если парсинг -- соблюдать robots.txt, минимальная нагрузка. Юридическая консультация.                         |
| **Автоматизация на foodie.fi**  | Автоматическое добавление товаров в корзину может нарушать ToS.                                        | Расширение работает от лица пользователя (его аккаунт, его действия). Изучить ToS foodie.fi. Рассмотреть партнёрство.                                          |
| **GDPR**                        | Хранение персональных данных (имена, аллергии, медицинские ограничения) подпадает под GDPR.            | Data Processing Agreement. Privacy Policy. Возможность экспорта и удаления данных. Согласие на обработку данных. Минимизация данных.                           |
| **Медицинская ответственность** | Рекомендации по питанию с учётом медицинских ограничений могут быть трактованы как медицинские советы. | Дисклеймер: "Система не заменяет медицинскую консультацию". Рекомендательный, а не директивный характер. Консультация с нутрициологом при формировании правил. |

### 11.3 Бизнес-риски

| Риск                                                                                               | Вероятность       | Влияние     | Митигация                                                                                                              |
| -------------------------------------------------------------------------------------------------- | ----------------- | ----------- | ---------------------------------------------------------------------------------------------------------------------- |
| **Низкий retention** -- пользователи пробуют, но не возвращаются                                   | Средняя           | Критическое | Фокус на качестве первого опыта (onboarding). Push-уведомления (web push) о начале новой недели. Анализ причин оттока. |
| **Ограниченный рынок** -- Хельсинки + S-Market -- узкая ниша                                       | Высокая (для MVP) | Среднее     | MVP -- валидация спроса. Архитектура с учётом расширения на другие магазины и города.                                  |
| **Зависимость от одного магазина** -- S-Market может закрыть интернет-магазин или изменить условия | Низкая            | Критическое | Абстракция магазина в архитектуре. Готовность к добавлению Prisma, K-Market.                                           |

### 11.4 Ограничения MVP

| Ограничение           | Описание                                                                         |
| --------------------- | -------------------------------------------------------------------------------- |
| Один магазин          | Только S-Market (Хельсинки). Нет сравнения цен между магазинами.                 |
| Один регион           | Только Хельсинки. Ассортимент привязан к конкретному магазину.                   |
| Только Chrome         | Chrome Extension работает только в Google Chrome (desktop).                      |
| Ограниченный каталог  | Начальный каталог ~500 основных товаров. Не все ингредиенты будут маппироваться. |
| Только веб-приложение | Нет мобильного приложения. Responsive web -- единственный мобильный вариант.     |
| Нет multi-user        | Один аккаунт = одна семья. Нет совместного доступа.                              |
| Английский + финский  | Только два языка интерфейса.                                                     |

---

## Приложение A: Глоссарий

| Термин                        | Определение                                                                                                      |
| ----------------------------- | ---------------------------------------------------------------------------------------------------------------- |
| **SKU**                       | Stock Keeping Unit -- уникальный идентификатор товара в каталоге магазина                                        |
| **EAN**                       | European Article Number -- международный штрих-код товара (13 цифр)                                              |
| **Маппинг**                   | Сопоставление абстрактного ингредиента с конкретным товаром в магазине                                           |
| **Content Script**            | JavaScript-код расширения Chrome, который внедряется на страницы определённого домена и может манипулировать DOM |
| **Background Service Worker** | Фоновый скрипт расширения Chrome (Manifest V3), обрабатывающий события и управляющий логикой                     |
| **LLM**                       | Large Language Model -- большая языковая модель (GPT-4, Claude и т.д.)                                           |
| **Structured Outputs**        | Функция OpenAI API, гарантирующая выдачу ответа в строго определённом JSON-формате                               |
| **SSE**                       | Server-Sent Events -- протокол для стриминга данных от сервера к клиенту                                         |

## Приложение B: Ссылки

| Ресурс                                    | URL                                                        |
| ----------------------------------------- | ---------------------------------------------------------- |
| foodie.fi                                 | https://www.foodie.fi                                      |
| S-Market                                  | https://www.s-kanava.fi/ketju/s-market                     |
| Chrome Extension Manifest V3              | https://developer.chrome.com/docs/extensions/mv3/          |
| OpenAI Structured Outputs                 | https://platform.openai.com/docs/guides/structured-outputs |
| GDPR (General Data Protection Regulation) | https://gdpr.eu                                            |
